/*
 VisualSearch.js 0.1.0
 (c) 2011 Samuel Clay, @samuelclay, DocumentCloud Inc.
 VisualSearch.js may be freely distributed under the MIT license.
 For all details and documentation:
 http://documentcloud.github.com/visualsearch
*/
(function(){if(!window.VS)window.VS={};if(!VS.app)VS.app={};if(!VS.ui)VS.ui={};if(!VS.model)VS.model={};if(!VS.utils)VS.utils={};VS.init=function(a){var b={callbacks:{search:$.noop,focus:$.noop,categoryMatches:$.noop,facetMatches:$.noop}};VS.options=_.extend({},b,a);VS.options.callbacks=_.extend({},b.callbacks,a.callbacks);VS.app.hotkeys.initialize();VS.app.searchQuery=new VS.model.SearchQuery;VS.app.searchBox=new VS.ui.SearchBox(a);if(a.container){b=VS.app.searchBox.render().el;$(a.container).html(b)}VS.app.searchBox.value(a.query||
"");return VS.app.searchBox}})();
VS.ui.SearchBox=Backbone.View.extend({id:"search",events:{"click .search_glyph":"showFacetCategoryMenu","click .cancel_search_box":"clearSearch","mousedown .VS-search-box":"focusSearch","dblclick .VS-search-box":"highlightSearch","click #search_button":"searchEvent"},initialize:function(){this.flags={allSelected:false};this.facetViews=[];this.inputViews=[];_.bindAll(this,"hideSearch","renderFacets","_maybeDisableFacets","disableFacets");VS.app.searchQuery.bind("refresh",this.renderFacets);$(document).bind("keydown",
this._maybeDisableFacets)},render:function(){$(this.el).append(JST.search_box({}));$(document.body).setMode("no","search");return this},hideSearch:function(){$(document.body).setMode(null,"search")},_maybeDisableFacets:function(a){if(this.flags.allSelected&&(VS.app.hotkeys.key(a)=="backspace"||VS.app.hotkeys.printable(a)))this.clearSearch();else if(this.flags.allSelected){console.log(["_maybeDisableFacets",this.flags.allSelected]);this.flags.allSelected=false;this.disableFacets()}},clearSearch:function(){console.log(["clearSearch"]);
this.value("");this.flags.allSelected=false;this.focusSearch()},searchEvent:function(a){var b=this.value();console.log(["real searchEvent",a,b,VS.options.callbacks]);this.focusSearch();VS.options.callbacks.search(b)!==false&&this.value(b)},value:function(a){if(a==null)return this.getQuery();return this.setQuery(a)},getQuery:function(){var a=[],b=this.inputViews.length;VS.app.searchQuery.each(_.bind(function(c,d){a.push(this.inputViews[d].value());a.push(c.serialize())},this));b&&a.push(this.inputViews[b-
1].value());console.log(["getQuery",a,_.compact(a)]);return _.compact(a).join(" ")},setQuery:function(a){this.currentQuery=a;VS.app.SearchParser.parse(a);this.clearInputs()},viewPosition:function(a){a=_.indexOf(a.type=="facet"?this.facetViews:this.inputViews,a);if(a==-1)a=0;return a},addFacet:function(a,b,c){a=VS.utils.inflector.trim(a);b=VS.utils.inflector.trim(b||"");if(a){console.log(["addFacet",a,b,c]);var d=new VS.model.SearchFacet({category:a,value:b||""});VS.app.searchQuery.add(d,{at:c});this.renderFacets();
_.detect(this.facetViews,function(f){if(f.model==d)return true}).enableEdit()}},renderFacets:function(){this.facetViews=[];this.inputViews=[];this.$(".search_inner").empty();VS.app.searchQuery.each(_.bind(function(a,b){this.renderFacet(a,b)},this));this.renderSearchInput()},renderFacet:function(a,b){var c=new VS.ui.SearchFacet({model:a,order:b});this.renderSearchInput();this.facetViews.push(c);this.$(".search_inner").children().eq(b*2).after(c.render().el);c.calculateSize();_.defer(_.bind(c.calculateSize,
c));return c},renderSearchInput:function(){var a=new VS.ui.SearchInput({position:this.inputViews.length});this.$(".search_inner").append(a.render().el);this.inputViews.push(a)},clearInputs:function(){_.each(this.inputViews,function(a){a.clear()})},focusNextFacet:function(a,b,c){c=c||{};var d=this.facetViews.length,f=c.viewPosition||this.viewPosition(a);console.log(["focusNextFacet",d,f,a.type,b,c]);if(c.skipToFacet){if(c.skipToFacet&&a.type=="text"&&d==f&&b>=0)b=f=0}else{if(a.type=="text"&&b>0)b-=
1;if(a.type=="facet"&&b<0)b+=1}var e;f=Math.min(d,f+b);if(a.type=="text"&&f>=0&&f<d){e=this.facetViews[f];if(c.selectFacet)e.selectFacet();else{e.enableEdit();e.setCursorAtEnd(b||c.startAtEnd)}}else if(a.type=="facet")if(c.skipToFacet)if(f>=d||f<0){e=_.last(this.inputViews);e.focus()}else{e=this.facetViews[f];e.enableEdit();e.setCursorAtEnd(b||c.startAtEnd)}else{e=this.inputViews[f];console.log(["next view",f,e]);e.focus();c.selectText&&e.selectText()}c.selectText&&e.selectText();this.resizeFacets()},
selectAllFacets:function(){_.each(this.facetViews,function(a){a.selectFacet(null,true)});_.each(this.inputViews,function(a){a.selectText()});this.flags.allSelected=true;$(document).one("click",this.disableFacets)},allSelected:function(){return this.flags.allSelected},disableFacets:function(a){_.each(this.facetViews,function(b){if(b!=a&&(b.modes.editing=="is"||b.modes.selected=="is")){console.log(["disabling view",b.model.get("category")]);b.disableEdit();b.deselectFacet()}});this.removeFocus()},resizeFacets:function(a){_.each(this.facetViews,
function(b){if(!a||b==a)b.resize()})},focusSearch:function(a,b){console.log(["focusSearch",a,!a||$(a.target).is(".VS-search-box")||$(a.target).is(".search_inner")]);if(!a||$(a.target).is(".VS-search-box")||$(a.target).is(".search_inner")){this.disableFacets();_.defer(_.bind(function(){this.$("input:focus").length||this.inputViews[this.inputViews.length-1].focus(b)},this))}},highlightSearch:function(a){this.focusSearch(a,true)},addFocus:function(){VS.options.callbacks.focus();this.$(".VS-search-box").addClass("VS-focus")},
removeFocus:function(){_.any(this.facetViews.concat(this.inputViews),function(a){return a.isFocused()})||this.$(".VS-search-box").removeClass("VS-focus")},showFacetCategoryMenu:function(a){a.preventDefault();a.stopPropagation();console.log(["showFacetCategoryMenu",a]);if(this.facetCategoryMenu&&this.facetCategoryMenu.modes.open=="is")return this.facetCategoryMenu.close();a=[{title:"Account",onClick:_.bind(this.addFacet,this,"account","")},{title:"Project",onClick:_.bind(this.addFacet,this,"project",
"")},{title:"Filter",onClick:_.bind(this.addFacet,this,"filter","")},{title:"Access",onClick:_.bind(this.addFacet,this,"access","")}];a=this.facetCategoryMenu||(this.facetCategoryMenu=new dc.ui.Menu({items:a,standalone:true}));this.$(".search_glyph").after(a.render().open().content);return false}});
VS.ui.SearchFacet=Backbone.View.extend({type:"facet",className:"search_facet",events:{"click .category":"selectFacet","keydown input":"keydown","keypress input":"keypress","mousedown input":"enableEdit","mouseover .cancel_search":"showDelete","mouseout .cancel_search":"hideDelete","click .cancel_search":"remove"},initialize:function(){this.setMode("not","editing");_.bindAll(this,"set","keydown","deselectFacet","deferDisableEdit")},render:function(){console.log(["search facet",this.model.get("category"),
this.model.get("value")]);(this.$el=$(this.el)).html(JST.search_facet({model:this.model}));this.setMode("not","editing");this.box=this.$("input");this.box.val(this.model.get("value"));this.box.bind("blur",this.deferDisableEdit);this.setupAutocomplete();return this},calculateSize:function(){this.box.autoGrowInput();this.box.unbind("updated.autogrow").bind("updated.autogrow",_.bind(this.moveAutocomplete,this))},setupAutocomplete:function(){this.box.autocomplete({source:_.bind(this.autocompleteValues,
this),minLength:0,delay:0,autoFocus:true,select:_.bind(function(a,b){a.preventDefault();var c=this.model.get("value");console.log(["autocomplete facet",b.item.value,c]);this.set(b.item.value);if(c!=b.item.value||this.box.val()!=b.item.value)this.search(a);return false},this)});this.box.autocomplete("widget").addClass("VS-interface")},moveAutocomplete:function(){var a=this.box.data("autocomplete");a&&a.menu.element.position({my:"left top",at:"left bottom",of:this.box.data("autocomplete").element,collision:"none"})},
set:function(a){if(a){console.log(["set facet",a,this.model.get("value"),this.model]);this.model.set({value:a})}},search:function(a){console.log(["facet search",a]);this.closeAutocomplete();VS.app.searchBox.searchEvent(a)},enableEdit:function(){this.canClose=false;console.log(["enableEdit",this.model.get("category"),this.modes.editing]);if(this.modes.editing!="is"){this.setMode("is","editing");this.deselectFacet();this.box.val()==""&&this.box.val(this.model.get("value"))}this.searchAutocomplete();
VS.app.searchBox.disableFacets(this);VS.app.searchBox.addFocus();_.defer(function(){VS.app.searchBox.addFocus()});this.box.is(":focus")||this.box.focus();this.resize()},deferDisableEdit:function(){console.log(["deferDisableEdit",this.model.get("category"),this.box.is(":focus")]);this.canClose=true;_.delay(_.bind(function(){console.log(["deferDisableEdit post",this.canClose,this.box.is(":focus"),this.modes.editing]);this.canClose&&!this.box.is(":focus")&&this.modes.editing=="is"&&this.modes.selected!=
"is"&&this.disableEdit()},this),250)},disableEdit:function(){console.log(["disableEdit",this.model.get("category"),this.box.is(":focus")]);var a=VS.utils.inflector.trim(this.box.val());a!=this.model.get("value")&&this.set(a);this.canClose=false;this.box.selectRange(0,0);this.box.blur();this.setMode("not","editing");this.closeAutocomplete();VS.app.searchBox.removeFocus()},selectFacet:function(a,b){console.log(["selectFacet",this.model.get("category"),b]);this.canClose=false;this.box.setCursorPosition(0);
this.box.is(":focus")&&this.box.blur();this.setMode("is","selected");this.setMode("not","editing");this.closeAutocomplete();if(!b){$(document).unbind("keydown.facet",this.keydown);$(document).unbind("click.facet",this.deselectFacet);_.defer(_.bind(function(){$(document).unbind("keydown.facet").bind("keydown.facet",this.keydown);$(document).unbind("click.facet").one("click.facet",this.deselectFacet)},this));VS.app.searchBox.disableFacets(this);VS.app.searchBox.addFocus()}},deselectFacet:function(){console.log(["deselectFacet",
this.model.get("category")]);if(this.modes.selected=="is"){this.setMode("not","selected");this.closeAutocomplete();VS.app.searchBox.removeFocus()}$(document).unbind("keydown.facet",this.keydown);$(document).unbind("click.facet",this.deselectFacet)},isFocused:function(){return this.box.is(":focus")},searchAutocomplete:function(){var a=this.box.data("autocomplete");a&&a.search()},closeAutocomplete:function(){console.log(["closeAutocomplete",this.model.get("category")]);var a=this.box.data("autocomplete");
a&&a.close()},autocompleteValues:function(a,b){var c=this.model.get("category"),d=this.model.get("value"),f=a.term;c=VS.options.callbacks.facetMatches(c)||[];if(f&&d!=f){f=VS.utils.inflector.escapeRegExp(f||"");var e=RegExp("\\b"+f,"i");c=$.grep(c,function(g){return e.test(g)||e.test(g.value)||e.test(g.label)})}b(_.sortBy(c,function(g){return g==d||g.value==d?"":g}))},showDelete:function(){this.$el.addClass("search_facet_maybe_delete")},hideDelete:function(){this.$el.removeClass("search_facet_maybe_delete")},
setCursorAtEnd:function(a){a==-1?this.box.setCursorPosition(this.box.val().length):this.box.setCursorPosition(0)},remove:function(a){console.log(["remove facet",a,this.model]);a=this.model.has("value");this.deselectFacet();this.disableEdit();VS.app.searchQuery.remove(this.model);a?this.search():VS.app.searchBox.renderFacets();VS.app.searchBox.focusNextFacet(this,0,{viewPosition:this.options.order})},removeLastCharacter:function(){console.log(["removeLastCharacter",this.box.val()]);var a=this.box.val();
this.box.val(a.substr(0,a.length-1));this.resize()},selectText:function(){this.box.selectRange(0,this.box.val().length)},keypress:function(a){VS.app.hotkeys.key(a)},keydown:function(a){var b=VS.app.hotkeys.key(a);console.log(["facet keydown",b,this.box.val(),this.box.getCursorPosition(),this.box.getSelection().length,VS.app.hotkeys.left,VS.app.hotkeys.right]);if(b=="enter"&&this.box.val()){this.disableEdit();this.search(a)}else if(b=="left"){if(this.box.getCursorPosition()==0&&!this.box.getSelection().length)if(this.modes.selected==
"is"){this.deselectFacet();VS.app.searchBox.focusNextFacet(this,-1,{startAtEnd:true})}else this.selectFacet()}else if(b=="right")if(this.modes.selected=="is"){a.preventDefault();this.deselectFacet();this.setCursorAtEnd(0);this.enableEdit()}else{if(this.box.getCursorPosition()==this.box.val().length){a.preventDefault();this.disableEdit();VS.app.searchBox.focusNextFacet(this,1)}}else if(VS.app.hotkeys.shift&&b=="tab"){a.preventDefault();this.deselectFacet();this.disableEdit();VS.app.searchBox.focusNextFacet(this,
-1,{startAtEnd:true,skipToFacet:true,selectText:true})}else if(b=="tab"){a.preventDefault();this.deselectFacet();this.disableEdit();VS.app.searchBox.focusNextFacet(this,1,{skipToFacet:true,selectText:true})}else if(VS.app.hotkeys.command&&(a.which==97||a.which==65)){a.preventDefault();VS.app.searchBox.selectAllFacets();return false}else if(VS.app.hotkeys.printable(a)&&this.modes.selected=="is"){VS.app.searchBox.focusNextFacet(this,-1,{startAtEnd:true});this.remove()}else if(b=="backspace")if(this.modes.selected==
"is"){a.preventDefault();this.remove(a)}else if(this.box.getCursorPosition()==0&&!this.box.getSelection().length){a.preventDefault();this.selectFacet()}this.resize(a)},resize:function(a){this.box.trigger("resize.autogrow",a)}});
VS.ui.SearchInput=Backbone.View.extend({type:"text",className:"search_input",events:{"keypress input":"keypress","keydown input":"keydown"},initialize:function(){_.bindAll(this,"removeFocus","addFocus","moveAutocomplete")},render:function(){$(this.el).html(JST.search_input({}));this.box=this.$("input");this.box.autoGrowInput();this.box.bind("updated.autogrow",this.moveAutocomplete);this.box.bind("blur",this.removeFocus);this.box.bind("focus",this.addFocus);this.setupAutocomplete();return this},setupAutocomplete:function(){this.box.autocomplete({minLength:1,
delay:50,autoFocus:true,source:_.bind(this.autocompleteValues,this),select:_.bind(function(a,b){console.log(["select autocomplete",a,b]);a.preventDefault();a.stopPropagation();var c=this.addTextFacetRemainder(b.item.value);VS.app.searchBox.addFacet(b.item.value,"",this.options.position+(c?1:0));this.clear();return false},this)});this.box.data("autocomplete")._renderMenu=function(a,b){var c="";_.each(b,_.bind(function(d){if(d.category&&d.category!=c){a.append('<li class="ui-autocomplete-category">'+
d.category+"</li>");c=d.category}this._renderItem(a,d)},this))};this.box.autocomplete("widget").addClass("VS-interface")},autocompleteValues:function(a,b){var c=a.term.match(/\w+$/);c=VS.utils.inflector.escapeRegExp(c&&c[0]||" ");var d=VS.options.callbacks.categoryMatches()||[],f=RegExp("^"+c,"i");c=$.grep(d,function(e){return f.test(e.label||e)});b(_.sortBy(c,function(e){return e.label?e.category+"-"+e.label:e}))},moveAutocomplete:function(){var a=this.box.data("autocomplete");a&&a.menu.element.position({my:"left top",
at:"left bottom",of:this.box.data("autocomplete").element,collision:"none"})},closeAutocomplete:function(){var a=this.box.data("autocomplete");a&&a.close()},addTextFacetRemainder:function(a){var b=this.box.val(),c=b.match(/\b(\w+)$/);if(c&&a.indexOf(c[0])==0)b=b.replace(/\b(\w+)$/,"");(b=b.replace("^s+|s+$",""))&&VS.app.searchBox.addFacet("text",b,this.options.position);return b},focus:function(a){console.log(["input focus",a]);this.addFocus();this.box.focus();a&&this.selectText()},blur:function(){console.log(["input blur"]);
this.box.blur();this.removeFocus()},removeFocus:function(a){console.log(["removeFocus",a]);VS.app.searchBox.removeFocus()},addFocus:function(a){console.log(["addFocus",a]);VS.app.searchBox.disableFacets(this);VS.app.searchBox.addFocus()},isFocused:function(){return this.box.is(":focus")},clear:function(){this.box.val("")},value:function(){return this.box.val()},selectText:function(){this.box.selectRange(0,this.box.val().length);this.box.focus()},keypress:function(a){var b=VS.app.hotkeys.key(a);console.log(["input keypress",
a.keyCode,b,this.box.getCursorPosition()]);if(b=="enter")return VS.app.searchBox.searchEvent(a);else if(VS.app.hotkeys.colon(a)){this.box.trigger("resize.autogrow",a);b=this.box.val();var c=VS.options.callbacks.categoryMatches()||[];_.map(c,function(d){return d.label?d.label:d});if(_.contains(_.pluck(c,"label"),b)){a.preventDefault();a=this.addTextFacetRemainder(b);VS.app.searchBox.addFacet(b,"",this.options.position+(a?1:0));this.clear();return false}}else if(b=="backspace")if(this.box.getCursorPosition()==
0&&!this.box.getSelection().length){a.preventDefault();a.stopPropagation();a.stopImmediatePropagation();VS.app.searchBox.resizeFacets();return false}},keydown:function(a){var b=VS.app.hotkeys.key(a);console.log(["input keydown",b,a.which,this.box.getCursorPosition()]);this.box.trigger("resize.autogrow",a);if(b=="left"){if(this.box.getCursorPosition()==0){a.preventDefault();VS.app.searchBox.focusNextFacet(this,-1,{startAtEnd:true})}}else if(b=="right"){if(this.box.getCursorPosition()==this.box.val().length){a.preventDefault();
VS.app.searchBox.focusNextFacet(this,1,{selectFacet:true})}}else if(VS.app.hotkeys.shift&&b=="tab"){a.preventDefault();VS.app.searchBox.focusNextFacet(this,-1,{selectText:true})}else if(b=="tab"){a.preventDefault();a=this.box.val();if(a.length){b=this.addTextFacetRemainder(a);VS.app.searchBox.addFacet(a,"",this.options.position+(b?1:0))}else VS.app.searchBox.focusNextFacet(this,0,{skipToFacet:true,selectText:true})}else if(VS.app.hotkeys.command&&(a.which==97||a.which==65)){a.preventDefault();VS.app.searchBox.selectAllFacets();
return false}else if(b=="backspace"&&!VS.app.searchBox.allSelected())if(this.box.getCursorPosition()==0&&!this.box.getSelection().length){a.preventDefault();VS.app.searchBox.focusNextFacet(this,-1,{backspace:true});return false}}});(function(){Backbone.View.prototype.setMode=function(a,b){this.modes||(this.modes={});if(this.modes[b]!==a){$(this.el).setMode(a,b);this.modes[b]=a}}})();
VS.app.hotkeys={KEYS:{"16":"shift","17":"control","91":"command","93":"command","224":"command","13":"enter","37":"left","38":"upArrow","39":"right","40":"downArrow","46":"delete","8":"backspace","9":"tab","188":"comma"},initialize:function(){_.bindAll(this,"down","up","blur");$(document).bind("keydown",this.down);$(document).bind("keyup",this.up);$(window).bind("blur",this.blur)},down:function(a){if(a=this.KEYS[a.which])this[a]=true},up:function(a){if(a=this.KEYS[a.which])this[a]=false},blur:function(){for(var a in this.KEYS)this[this.KEYS[a]]=
false},key:function(a){return this.KEYS[a.which]},colon:function(a){return(a=a.which)&&String.fromCharCode(a)==":"},printable:function(a){var b=a.which;if(a.type=="keydown"){if(b==32||b>=48&&b<=90||b>=96&&b<=111||b>=186&&b<=192||b>=219&&b<=222)return true}else if(b>=32&&b<=126||b>=160&&b<=500||String.fromCharCode(b)==":")return true;return false}};
VS.utils.inflector={small:"(a|an|and|as|at|but|by|en|for|if|in|of|on|or|the|to|v[.]?|via|vs[.]?)",punct:"([!\"#$%&'()*+,./:;<=>?@[\\\\\\]^_`{|}~-]*)",pluralize:function(a,b){if(b==1)return a;if(a=="this")return"these";if(a=="person")return"people";if(a=="this")return"these";if(a.match(/y$/i))return a.replace(/y$/i,"ies");return a+"s"},titleize:function(a){a=a.replace(/[-.\/_]/g," ").replace(/\s+/gm," ");for(var b=this.capitalize,c=[],d=/[:.;?!] |(?: |^)["\u00d2]/g,f=0;;){var e=d.exec(a);c.push(a.substring(f,
e?e.index:a.length).replace(/\b([A-Za-z][a-z.'\u00d5]*)\b/g,function(g){return/[A-Za-z]\.[A-Za-z]/.test(g)?g:b(g)}).replace(RegExp("\\b"+this.small+"\\b","ig"),this.lowercase).replace(RegExp("^"+this.punct+this.small+"\\b","ig"),function(g,h,i){return h+b(i)}).replace(RegExp("\\b"+this.small+this.punct+"$","ig"),b));f=d.lastIndex;if(e)c.push(e[0]);else break}return c.join("").replace(/ V(s?)\. /ig," v$1. ").replace(/(['\u00d5])S\b/ig,"$1s").replace(/\b(AT&T|Q&A)\b/ig,function(g){return g.toUpperCase()})},
trim:function(a){return a.trim?a.trim():a.replace(/^\s+|\s+$/g,"")},truncate:function(a,b,c){b=b||30;c=c==null?"...":c;return a.length>b?a.slice(0,b-c.length)+c:a},escapeRegExp:function(a){return a.replace(/([.*+?^${}()|[\]\/\\])/g,"\\$1")}};
(function(a){a.fn.extend({setMode:function(b,c){c=c||"mode";var d=RegExp("\\w+_"+c+"(\\s|$)","g"),f=b===null?"":b+"_"+c;this.each(function(){this.className=(this.className.replace(d,"")+" "+f).replace(/\s\s/g," ")});return f},autoGrowInput:function(){return this.each(function(){var b=a(this),c=a("<div />").css({opacity:0,top:-9999,left:-9999,position:"absolute",whiteSpace:"nowrap"}).addClass("input_width_tester").addClass("VS-interface");b.after(c);b.unbind("keydown.autogrow keypress.autogrow resize.autogrow change.autogrow").bind("keydown.autogrow keypress.autogrow resize.autogrow change.autogrow",
function(d,f){if(f)d=f;var e=b.val();VS.app.hotkeys.down(d);if(VS.app.hotkeys.key(d)=="backspace"){var g=b.getCursorPosition();if(g>0)e=e.slice(0,g-1)+e.slice(g,e.length)}else if(VS.app.hotkeys.printable(d)&&!VS.app.hotkeys.command)e+=VS.app.hotkeys.shift?String.fromCharCode(d.which):String.fromCharCode(d.which).toLowerCase();e=e.replace(/&/g,"&amp;").replace(/\s/g,"&nbsp;").replace(/</g,"&lt;").replace(/>/g,"&gt;");c.html(e);console.log(["autoGrow",d.type,d.which,VS.app.hotkeys.printable(d),e]);
b.width(c.width()+3);b.trigger("updated.autogrow")});b.trigger("resize.autogrow")})},getCursorPosition:function(){var b=0,c=this.get(0);if(document.selection){c.focus();b=document.selection.createRange();var d=document.selection.createRange().text.length;b.moveStart("character",-c.value.length);b=b.text.length-d}else if(c&&a(c).is(":visible")&&c.selectionStart!=null)b=c.selectionStart;return b},setCursorPosition:function(b){return this.each(function(){return a(this).selectRange(b,b)})},selectRange:function(b,
c){return this.each(function(){if(this.setSelectionRange){this.focus();this.setSelectionRange(b,c)}else if(this.createTextRange){var d=this.createTextRange();d.collapse(true);d.moveEnd("character",c);d.moveStart("character",b);d.select()}})},getSelection:function(){var b=this[0];if(b.selectionStart!=null){var c=b.selectionStart,d=b.selectionEnd;return{start:c,end:d,length:d-c,text:b.value.substr(c,d-c)}}else if(document.selection){var f=document.selection.createRange();if(f){b=b.createTextRange();
c=b.duplicate();b.moveToBookmark(f.getBookmark());c.setEndPoint("EndToStart",b);c=c.text.length;d=c+f.text.length;return{start:c,end:d,length:d-c,text:f.text}}}return{start:0,end:0,length:0}}})})(jQuery);
VS.app.SearchParser={ALL_FIELDS:/('.+?'|".+?"|[^'"\s]{2}\S*):\s*('.+?'|".+?"|[^'"\s]{2}\S*)/g,FIELD:/(.+?):\s*/,ONE_ENTITY:/(city|country|term|state|person|place|organization|email|phone):\s*(([^'"][^'"]\S*)|'(.+?)'|"(.+?)")/i,ALL_ENTITIES:/(city|country|term|state|person|place|organization|email|phone):\s*(([^'"][^'"]\S*)|'(.+?)'|"(.+?)")/ig,parse:function(a){a=this.extractAllFacets(a);VS.app.searchQuery.refresh(a)},extractAllFacets:function(a){for(var b=[],c=a;a;){var d,f;c=a;var e=this.extractNextField(a);
if(e)if(e.indexOf(":")!=-1){d=e.match(this.FIELD)[1];f=e.replace(this.FIELD,"").replace(/(^['"]|['"]$)/g,"");a=VS.utils.inflector.trim(a.replace(e,""))}else{if(e.indexOf(":")==-1){d="text";f=e;a=VS.utils.inflector.trim(a.replace(f,""))}}else{d="text";f=this.extractSearchText(a);a=VS.utils.inflector.trim(a.replace(f,""))}if(d&&f){e=new VS.model.SearchFacet({category:d,value:VS.utils.inflector.trim(f)});b.push(e)}if(c==a)break}return b},extractNextField:function(a){var b=a.match(/^\s*(\S+)\s+(?=\w+:\s?(('.+?'|".+?")|([^'"]{2}\S*)))/);
console.log(["extractNextField",a,b]);return b&&b.length>=1?b[1]:this.extractFirstField(a)},extractFirstField:function(a){return(a=a.match(this.ALL_FIELDS))&&a.length&&a[0]},extractSearchText:function(a){a=a||"";var b=VS.utils.inflector.trim(a.replace(this.ALL_FIELDS,""));console.log(["extractSearchText",a,b]);return b},extractEntities:function(a){var b=this.ONE_ENTITY;a=a.match(this.ALL_ENTITIES)||[];return _.sortBy(_.map(a,function(c){c=c.match(b);return{type:c[1],value:c[3]||c[4]||c[5]}}),function(c){return c.value.toLowerCase()}).reverse()}};
VS.model.SearchFacet=Backbone.Model.extend({UNQUOTABLE_CATEGORIES:["text","account","document","filter","group","access","related","projectid"],serialize:function(){var a=this.get("category"),b=VS.utils.inflector.trim(this.get("value"));if(!b)return"";_.contains(this.UNQUOTABLE_CATEGORIES,a)||(b='"'+b+'"');if(a!="text")a+=": ";else a="";return a+b}});
VS.model.SearchQuery=Backbone.Collection.extend({model:VS.model.SearchFacet,value:function(){return this.map(function(a){return a.serialize()}).join(" ")},find:function(a){var b=this.detect(function(c){return c.get("category")==a});return b&&b.get("value")},count:function(a){return this.select(function(b){return b.get("category")==a}).length},values:function(a){var b=this.select(function(c){return c.get("category")==a});return _.map(b,function(c){return c.get("value")})},has:function(a,b){return this.any(function(c){return b?
c.get("category")==a&&c.get("value")==b:c.get("category")==a})},withoutCategory:function(a){return this.map(function(b){if(b.get("category")!=a)return b.serialize()}).join(" ")}});
(function(){window.JST=window.JST||{};window.JST.search_box=_.template('<div class="VS-search">  <div id="search_container">    <div id="search_button" class="minibutton">Search</div>    <div id="search_box_wrapper" class="VS-search-box">      <div class="icon search_glyph"></div>      <div class="search_inner"></div>      <div class="icon cancel_search cancel_search_box" title="clear search"></div>    </div>  </div></div>');window.JST.search_facet=_.template('<% if (model.has(\'category\')) { %>  <div class="category"><%= model.get(\'category\') %>:</div><% } %><div class="search_facet_input_container">  <input type="text" class="search_facet_input VS-interface" value="" /></div><div class="search_facet_remove icon cancel_search"></div>');
window.JST.search_input=_.template('<input class="search_box" type="text" />')})();
